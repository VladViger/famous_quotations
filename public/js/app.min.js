$(".btn-about").on("click",function(){$(".description").toggleClass("hide-xs"),$(this).find(".icon").toggleClass("flaticon-cross")}),$(".sort").on("click",function(){$(this).toggleClass("active"),$('.toolbar [class*="sort-"]').toggleClass("mobile-height")});var USER_IP;$.getJSON("http://jsonip.com/",function(t){USER_IP=t.ip});var Article=Backbone.Model.extend({defaults:{text:"",author:"неизвестный автор",creator:"аноним",liked:[]},initialize:function(){if(this.calcRating(),this.bind("change:liked",this.calcRating),this.bind("invalid",this.showError),!this.get("theDate")){var t=new Date;this.set({theDate:+t}),this.set({theDateString:this.getDateString(t)})}this.get("creatorIP")||this.set({creatorIP:USER_IP}),this.get("author")||this.set({author:this.defaults.author}),this.get("creator")||this.set({creator:this.defaults.creator})},validate:function(t){var e="Ошибка! \nСлишком короткая цитата.",i="Ошибка! \nСлишком длинная цитата.",s="Ошибка! \nИмя автора должно содержать от 3 до 40 символов.",r="Ошибка! \nПодпись должна содержать от 3 до 20 символов.";return t.text.length<20?e:t.text.length>1e3?i:t.author.length<3||t.author.length>40?s:t.creator.length<3||t.creator.length>20?r:void 0},getDateString:function(t){var e,i,s;return e=("0"+t.getDate()).slice(-2),i=("0"+(t.getMonth()+1)).slice(-2),s=t.getFullYear(),e+"-"+i+"-"+s},calcRating:function(){this.set("rating",this.get("liked").length)},addLike:function(){var t=_.union(this.get("liked"),[USER_IP]);this.set("liked",t),this.save()},removeLike:function(){var t=_.without(this.get("liked"),USER_IP);this.set("liked",t),this.save()},clear:function(){this.destroy()},showError:function(t,e){alert(e)},urlRoot:"/fq",idAttribute:"_id"}),ArticleList=Backbone.Collection.extend({model:Article,comparator:function(t){return+t.get("theDate")},sortByDateUp:function(){this.models.sort(function(t,e){return t.get("theDate")-e.get("theDate")})},sortByDateDown:function(){this.models.sort(function(t,e){return e.get("theDate")-t.get("theDate")})},sortByRatingUp:function(){this.models.sort(function(t,e){return t.get("rating")-e.get("rating")})},sortByRatingDown:function(){this.models.sort(function(t,e){return e.get("rating")-t.get("rating")})},sortByAuthorUp:function(){this.models.sort(function(t,e){return t.get("author").toLowerCase()<e.get("author").toLowerCase()?1:-1})},sortByAuthorDown:function(){this.models.sort(function(t,e){return t.get("author").toLowerCase()>e.get("author").toLowerCase()?1:-1})},url:"/fq"}),articleList=new ArticleList;articleList.fetch();var ArticleView=Backbone.View.extend({tagName:"article",className:"quote-wrap",template:_.template($("#article-template").html()),events:{"click .delete.active":"clear","click .rating":"toLike","click .edit.active":"edit"},initialize:function(){this.model.bind("destroy",this.remove,this),this.model.bind("removeView",this.remove,this),this.model.bind("change:rating",this.render,this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.setRights(),this.setLiked(),this},setRights:function(){var t,e=this;t=USER_IP?0:1e3,setTimeout(function(){e.model.get("creatorIP")==USER_IP&&e.$el.find(".delete, .edit").addClass("active")},t)},setLiked:function(){var t,e=this;t=USER_IP?0:1e3,setTimeout(function(){-1!=e.model.get("liked").indexOf(USER_IP)&&e.$el.find(".rating").addClass("liked")},t)},clear:function(){this.model.clear()},toLike:function(t){$(t.target).hasClass("liked")?this.model.removeLike():this.model.addLike(),$(t.target).toggleClass("liked")},edit:function(){var t=new EditView({model:this.model});this.$el.html(t.render().el),t.articleView=this}}),AddingView=Backbone.View.extend({tagName:"section",className:"row",template:_.template($("#set-quote-template").html()),events:{"click .btn-cancel":"cancel","click .btn-set-quote":"addNewQuote"},render:function(){return this.$el.html(this.template()),this},cancel:function(){this.remove()},addNewQuote:function(t){t.preventDefault();var e=this.$el.find(".quote-text").val(),i=this.$el.find(".quote-author").val(),s=this.$el.find(".quote-sign").val(),r=new Article({text:e,author:i,creator:s});r.isValid()?(r.save(),articleList.add(r),this.remove()):(r.validationError,r.destroy())}}),EditView=AddingView.extend({events:{"click .btn-cancel":"cancel","click .btn-set-quote":"editQuote"},render:function(){return this.$el.html(this.template()),this.$el.find(".quote-text").val(this.model.get("text")),this.$el.find(".quote-author").val(this.model.get("author")),this.$el.find(".quote-sign").val(this.model.get("creator")),this},cancel:function(t){t.preventDefault(),this.articleView.render(),this.remove()},editQuote:function(t){t.preventDefault();var e=this.$el.find(".quote-text").val(),i=this.$el.find(".quote-author").val(),s=this.$el.find(".quote-sign").val();this.model.save({text:e,author:i,creator:s}),this.articleView.render(),this.remove()}}),AppView=Backbone.View.extend({el:$("#toolbar"),events:{"click .add-quote":"showForm","click .sort-date":"sortByDate","click .sort-rating":"sortByRating","click .sort-name":"sortByAuthor"},initialize:function(){this.addAll(articleList),articleList.bind("add",this.addOne,this)},addOne:function(t){var e=new ArticleView({model:t});this.$el.after(e.render().el)},addAll:function(t){_.each(t.models,function(t){this.addOne(t)},this)},clear:function(t){_.each(t.models,function(t){t.trigger("removeView")})},showForm:function(){if(!$(".set-quote").length){var t=new AddingView;this.$el.after(t.render().el)}},setClassSortEl:function(t){var e=$(t);e.hasClass("active")||(this.$el.find(".active").removeClass("active"),e.addClass("active")),e.toggleClass("up")},sortByDate:function(t){$(t.currentTarget).hasClass("up")?articleList.sortByDateDown():articleList.sortByDateUp(),this.clear(articleList),this.addAll(articleList),this.setClassSortEl(t.currentTarget)},sortByRating:function(t){$(t.currentTarget).hasClass("up")?articleList.sortByRatingDown():articleList.sortByRatingUp(),this.clear(articleList),this.addAll(articleList),this.setClassSortEl(t.currentTarget)},sortByAuthor:function(t){$(t.currentTarget).hasClass("up")?articleList.sortByAuthorDown():articleList.sortByAuthorUp(),this.clear(articleList),this.addAll(articleList),this.setClassSortEl(t.currentTarget)}}),app=new AppView;